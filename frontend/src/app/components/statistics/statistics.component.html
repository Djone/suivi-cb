<div class="statistics-container">
  <!-- Filtres -->
  <div class="section-wrapper">
    <p-card styleClass="filters-card">
      <div class="filters-grid">
        <div class="filter-item">
          <label>Compte</label>
          <p-dropdown
            [options]="accountOptions"
            [(ngModel)]="selectedAccount"
            (onChange)="applyFilters()"
            placeholder="Sélectionnez un compte"
            [style]="{ width: '100%' }"
          >
          </p-dropdown>
        </div>

        <div class="filter-item">
          <label>Année</label>
          <p-dropdown
            [options]="yearOptions"
            [(ngModel)]="selectedYear"
            (onChange)="applyFilters()"
            [style]="{ width: '100%' }"
          >
          </p-dropdown>
        </div>

        <div class="filter-item">
          <label>Mois</label>
          <p-dropdown
            [options]="availableMonths"
            [(ngModel)]="selectedMonth"
            (onChange)="applyFilters()"
            placeholder="Sélectionnez un mois"
            [style]="{ width: '100%' }"
          >
          </p-dropdown>
        </div>

        <div class="filter-item">
          <p-button
            label="Réinitialiser"
            icon="pi pi-refresh"
            (onClick)="
              selectedAccount = null; selectedMonth = null; applyFilters()
            "
            styleClass="p-button-outlined"
          >
          </p-button>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Evolution mensuelle -->
  <div class="section-wrapper">
    <p-card
      header="Évolution mensuelle {{ selectedYear }}"
      styleClass="evolution-card"
    >
      <div class="chart-container-wide" *ngIf="isBrowser">
        <canvas
          baseChart
          [data]="lineChartData"
          [type]="lineChartType"
          [options]="lineChartOptions"
        >
        </canvas>
      </div>

      <div class="evolution-table">
        <p-table [value]="monthlyEvolution" [paginator]="false">
          <ng-template pTemplate="header">
            <tr>
              <th>Mois</th>
              <th class="text-right">Dépenses</th>
              <th class="text-right">Revenus</th>
              <th class="text-right">Solde</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-month>
            <tr>
              <td>
                <strong>{{ month.month }}</strong>
              </td>
              <td class="text-right amount-cell negative">
                {{
                  month.expenses | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                }}
              </td>
              <td class="text-right amount-cell positive">
                {{ month.income | currency: "EUR" : "symbol" : "1.2-2" : "fr" }}
              </td>
              <td
                class="text-right amount-cell"
                [class.positive]="month.balance > 0"
                [class.negative]="month.balance < 0"
              >
                {{
                  month.balance | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-card>
  </div>

  <!-- Vue annuelle -->
  <div class="section-wrapper">
    <p-card header="Vue annuelle par catégorie" styleClass="tabs-card">
      <p-tabView>
        <p-tabPanel header="Dépenses">
          <div class="table-description">
            Totaux et moyennes mensuels des catégories, avec le détail par
            sous-catégorie.
          </div>
          <div
            class="monthly-table-wrapper"
            *ngIf="expensesMonthlyTable.length > 0; else noExpenseData"
          >
            <table class="plain-table">
              <thead>
                <tr>
                  <th class="expander-column"></th>
                  <th>Catégorie</th>
                  <th *ngFor="let month of monthColumns" class="text-right">
                    {{ month.label }}
                  </th>
                  <th class="text-right">Total</th>
                  <th class="text-right">Moyenne</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let category of expensesMonthlyTable">
                  <tr>
                    <td>
                      <button
                        type="button"
                        pButton
                        class="p-button-text p-button-rounded p-button-plain toggle-button"
                        [icon]="
                          expenseExpanded[category.label]
                            ? 'pi pi-chevron-down'
                            : 'pi pi-chevron-right'
                        "
                        (click)="toggleExpenseRow(category.label)"
                      ></button>
                    </td>
                    <td class="row-label">{{ category.label }}</td>
                    <td
                      *ngFor="let month of monthColumns"
                      class="text-right amount-cell negative"
                    >
                      {{
                        category.monthlyTotals[month.index]
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                    <td class="text-right amount-cell negative">
                      {{
                        category.total
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                    <td class="text-right amount-cell negative">
                      {{
                        category.average
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                  </tr>
                  <tr *ngIf="expenseExpanded[category.label]">
                    <td
                      [attr.colspan]="monthColumns.length + 4"
                      class="expansion-cell"
                    >
                      <table class="plain-table sub-table">
                        <tbody>
                          <tr *ngFor="let sub of category.subCategories">
                            <td class="row-label">{{ sub.label }}</td>
                            <td
                              *ngFor="let month of monthColumns"
                              class="text-right amount-cell negative"
                            >
                              {{
                                sub.monthlyTotals[month.index]
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                            <td class="text-right amount-cell negative">
                              {{
                                sub.total
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                            <td class="text-right amount-cell negative">
                              {{
                                sub.average
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
          <ng-template #noExpenseData>
            <div class="no-data">Aucune dépense pour cette période.</div>
          </ng-template>
        </p-tabPanel>

        <p-tabPanel header="Revenus">
          <div class="table-description">
            Totaux et moyennes mensuels des catégories, avec le détail par
            sous-catégorie.
          </div>
          <div
            class="monthly-table-wrapper"
            *ngIf="incomesMonthlyTable.length > 0; else noIncomeData"
          >
            <table class="plain-table">
              <thead>
                <tr>
                  <th class="expander-column"></th>
                  <th>Catégorie</th>
                  <th *ngFor="let month of monthColumns" class="text-right">
                    {{ month.label }}
                  </th>
                  <th class="text-right">Total</th>
                  <th class="text-right">Moyenne</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let category of incomesMonthlyTable">
                  <tr>
                    <td>
                      <button
                        type="button"
                        pButton
                        class="p-button-text p-button-rounded p-button-plain toggle-button"
                        [icon]="
                          incomeExpanded[category.label]
                            ? 'pi pi-chevron-down'
                            : 'pi pi-chevron-right'
                        "
                        (click)="toggleIncomeRow(category.label)"
                      ></button>
                    </td>
                    <td class="row-label">{{ category.label }}</td>
                    <td
                      *ngFor="let month of monthColumns"
                      class="text-right amount-cell positive"
                    >
                      {{
                        category.monthlyTotals[month.index]
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                    <td class="text-right amount-cell positive">
                      {{
                        category.total
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                    <td class="text-right amount-cell positive">
                      {{
                        category.average
                          | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                      }}
                    </td>
                  </tr>
                  <tr *ngIf="incomeExpanded[category.label]">
                    <td
                      [attr.colspan]="monthColumns.length + 4"
                      class="expansion-cell"
                    >
                      <table class="plain-table sub-table">
                        <thead>
                          <tr>
                            <th>Sous-catégorie</th>
                            <th
                              *ngFor="let month of monthColumns"
                              class="text-right"
                            >
                              {{ month.label }}
                            </th>
                            <th class="text-right">Total</th>
                            <th class="text-right">Moyenne</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let sub of category.subCategories">
                            <td class="row-label">{{ sub.label }}</td>
                            <td
                              *ngFor="let month of monthColumns"
                              class="text-right amount-cell positive"
                            >
                              {{
                                sub.monthlyTotals[month.index]
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                            <td class="text-right amount-cell positive">
                              {{
                                sub.total
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                            <td class="text-right amount-cell positive">
                              {{
                                sub.average
                                  | currency: "EUR" : "symbol" : "1.2-2" : "fr"
                              }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
          <ng-template #noIncomeData>
            <div class="no-data">Aucun revenu pour cette période.</div>
          </ng-template>
        </p-tabPanel>
      </p-tabView>
    </p-card>
  </div>
</div>
