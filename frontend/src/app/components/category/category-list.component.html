<section class="category-page">
  <header class="page-header">
    <div class="header-actions">
      <span class="search-wrapper">
        <i class="pi pi-search"></i>
        <input
          type="text"
          placeholder="Rechercher une catégorie ou sous-catégorie..."
          (input)="applyGlobalFilter($event)"
        />
      </span>
      <button
        pButton
        type="button"
        label="Nouvelle catégorie"
        icon="pi pi-plus"
        class="primary-btn"
        (click)="createCategory()"
      ></button>
    </div>
  </header>

  <p-tabView class="tab-wrapper" [scrollable]="true">
    <p-tabPanel header="Dépenses">
      <div class="category-grid">
        <article
          class="category-card"
          *ngFor="let category of expenseCategories"
        >
          <header class="card-header">
            <div class="card-main-row">
              <div>
                <h3>{{ category.label }}</h3>
              </div>
              <div class="card-actions">
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  [text]="true"
                  pTooltip="Ajouter une sous-catégorie"
                  (click)="createSubCategory(category)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  [text]="true"
                  pTooltip="Modifier la catégorie"
                  (click)="editCategory(category)"
                ></button>
                <p-inputSwitch
                  [ngModel]="category.isActive"
                  [trueValue]="1"
                  [falseValue]="0"
                  (onChange)="toggleActive(category, $event)"
                  pTooltip="Activer / Désactiver"
                ></p-inputSwitch>
                <button
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  label="Voir"
                  class="view-btn"
                  (click)="viewCategoryTransactions(category)"
                ></button>
              </div>
            </div>
            <p-tag
              [value]="category.statusLabel"
              [severity]="getSeverity(category.isActive)"
            ></p-tag>
          </header>

          <section
            class="sub-list"
            *ngIf="category.subCategories?.length; else emptyExpenseSubs"
          >
            <div class="sub-chip-grid">
              <div class="sub-chip" *ngFor="let sub of category.subCategories">
                <div class="sub-chip-row">
                  <span class="sub-chip-label">
                    {{ sub.label }}
                    <span class="op-count" *ngIf="sub.operationsCount !== undefined; else fallbackCount">
                      {{ sub.operationsCount }}
                    </span>
                    <ng-template #fallbackCount>
                      <span class="op-count">0</span>
                    </ng-template>
                  </span>
                </div>
                <div class="sub-chip-actions">
                  <button
                    pButton
                    type="button"
                    icon="pi pi-pencil"
                    [text]="true"
                    class="edit-action"
                    (click)="editSubCategory(sub)"
                  ></button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-trash"
                    [text]="true"
                    class="danger"
                    (click)="deleteSubCategory(sub)"
                  ></button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-search"
                    [text]="true"
                    (click)="viewSubCategoryTransactions(sub)"
                  ></button>
                </div>
              </div>
            </div>
          </section>
          <ng-template #emptyExpenseSubs>
            <p class="empty-state">Aucune sous-catégorie</p>
          </ng-template>
        </article>
        <div class="empty-state" *ngIf="expenseCategories.length === 0">
          Aucune catégorie de dépense trouvée.
        </div>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Revenus">
      <div class="category-grid">
        <article
          class="category-card"
          *ngFor="let category of revenueCategories"
        >
          <header class="card-header">
            <div class="card-main-row">
              <div>
                <h3>{{ category.label }}</h3>
              </div>
              <div class="card-actions">
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  [text]="true"
                  pTooltip="Ajouter une sous-catégorie"
                  (click)="createSubCategory(category)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  [text]="true"
                  pTooltip="Modifier la catégorie"
                  (click)="editCategory(category)"
                ></button>
                <p-inputSwitch
                  [ngModel]="category.isActive"
                  [trueValue]="1"
                  [falseValue]="0"
                  (onChange)="toggleActive(category, $event)"
                  pTooltip="Activer / Désactiver"
                ></p-inputSwitch>
                <button
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  label="Voir"
                  class="view-btn"
                  (click)="viewCategoryTransactions(category)"
                ></button>
              </div>
            </div>
            <p-tag
              [value]="category.statusLabel"
              [severity]="getSeverity(category.isActive)"
            ></p-tag>
          </header>

          <section
            class="sub-list"
            *ngIf="category.subCategories?.length; else emptyRevenueSubs"
          >
            <p class="eyebrow small">Sous-catégories</p>
            <div class="sub-chip-grid">
              <div class="sub-chip" *ngFor="let sub of category.subCategories">
                <div class="sub-chip-row">
                  <span class="sub-chip-label">
                    {{ sub.label }}
                    <span class="op-count" *ngIf="sub.operationsCount !== undefined; else fallbackCountRevenue">
                      {{ sub.operationsCount }}
                    </span>
                    <ng-template #fallbackCountRevenue>
                      <span class="op-count">0</span>
                    </ng-template>
                  </span>
                </div>
                <div class="sub-chip-actions">
                  <button
                    pButton
                    type="button"
                    icon="pi pi-pencil"
                    [text]="true"
                    class="edit-action"
                    (click)="editSubCategory(sub)"
                  ></button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-trash"
                    [text]="true"
                    class="danger"
                    (click)="deleteSubCategory(sub)"
                  ></button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-search"
                    [text]="true"
                    (click)="viewSubCategoryTransactions(sub)"
                  ></button>
                </div>
              </div>
            </div>
          </section>
          <ng-template #emptyRevenueSubs>
            <p class="empty-state">Aucune sous-catégorie</p>
          </ng-template>
        </article>
        <div class="empty-state" *ngIf="revenueCategories.length === 0">
          Aucune catégorie de revenu trouvée.
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>
</section>
