<div class="card">
  <p-card>
    <p-table
      #dt
      [value]="recurringTransactions"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 20, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} à {last} sur {totalRecords} récurrences"
      [globalFilterFields]="['label', 'amount', 'dayOfMonth', 'frequency', 'subCategoryId', 'accountId', 'isActive']"
      [tableStyle]="{ 'min-width': '75rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped">

      <!-- En-tête avec bouton "Nouvelle récurrence" -->
      <ng-template pTemplate="caption">
        <div class="flex align-items-center justify-content-between">
          <p-button
            label="Nouvelle récurrence"
            icon="pi pi-plus"
            (onClick)="createRecurringTransaction()"
            styleClass="p-button-success">
          </p-button>
        </div>
      </ng-template>

      <!-- En-têtes de colonnes -->
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="label" style="width:20%">Libellé <p-sortIcon field="label" /></th>
          <th pSortableColumn="amount" style="width:10%">Montant <p-sortIcon field="amount" /></th>
          <th pSortableColumn="dayOfMonth" style="width:8%">Jour <p-sortIcon field="dayOfMonth" /></th>
          <th pSortableColumn="frequency" style="width:12%">Fréquence <p-sortIcon field="frequency" /></th>
          <th pSortableColumn="subCategoryId" style="width:18%">Sous-catégorie <p-sortIcon field="subCategoryId" /></th>
          <th pSortableColumn="accountId" style="width:12%">Compte <p-sortIcon field="accountId" /></th>
          <th pSortableColumn="isActive" style="width:10%">Statut <p-sortIcon field="isActive" /></th>
          <th style="width:10%">Actions</th>
        </tr>
        <!-- Filtres -->
        <tr>
          <th>
            <input pInputText type="text" (input)="dt.filter($any($event.target).value, 'label', 'contains')" placeholder="Filtrer par libellé" class="w-full p-inputtext-sm">
          </th>
          <th>
            <p-inputNumber
              (onInput)="dt.filter($event.value, 'amount', 'equals')"
              mode="currency" currency="EUR" placeholder="Montant"
              styleClass="w-full" inputStyleClass="w-full p-inputtext-sm"
              [showButtons]="false">
            </p-inputNumber>
          </th>
          <th>
            <p-inputNumber
              (onInput)="dt.filter($event.value, 'dayOfMonth', 'equals')"
              placeholder="Jour"
              styleClass="w-full" inputStyleClass="w-full p-inputtext-sm"
              [showButtons]="false">
            </p-inputNumber>
          </th>
          <th>
            <p-dropdown
              [options]="frequencies"
              (onChange)="dt.filter($any($event.value), 'frequency', 'equals')"
              placeholder="Toutes" [showClear]="true"
              styleClass="w-full p-inputtext-sm">
            </p-dropdown>
          </th>
          <th>
            <p-dropdown
              [options]="subCategories" optionLabel="label" optionValue="id"
              (onChange)="dt.filter($any($event.value), 'subCategoryId', 'equals')"
              placeholder="Toutes" [showClear]="true" [filter]="true" filterBy="label"
              styleClass="w-full p-inputtext-sm">
            </p-dropdown>
          </th>
          <th>
            <p-dropdown
              [options]="accounts" optionLabel="name" optionValue="id"
              (onChange)="dt.filter($any($event.value), 'accountId', 'equals')"
              placeholder="Tous" [showClear]="true" [filter]="true" filterBy="name"
              styleClass="w-full p-inputtext-sm">
            </p-dropdown>
          </th>
          <th>
            <p-dropdown
              [options]="statuses"
              (onChange)="dt.filter($any($event.value), 'isActive', 'equals')"
              placeholder="Tous" [showClear]="true"
              styleClass="w-full p-inputtext-sm">
            </p-dropdown>
          </th>
          <th></th>
        </tr>
      </ng-template>

      <!-- Corps du tableau -->
      <ng-template pTemplate="body" let-transaction>
        <tr>
          <td>{{ transaction.label }}</td>
          <td>
            <p-tag
              [value]="(transaction.amount | currency:'EUR':'symbol':'1.2-2':'fr') ?? ''"
              [severity]="getFinancialFlowSeverity(transaction.financialFlowId)">
            </p-tag>
          </td>
          <td>{{ getDayLabel(transaction) }}</td>
          <td>{{ getFrequencyLabel(transaction.frequency) }}</td>
          <td>{{ getSubCategoryName(transaction.subCategoryId) }}</td>
          <td>
            <p-tag
              [value]="getAccountName(transaction.accountId)"
              [ngStyle]="getAccountStyle(transaction.accountId)">
            </p-tag>
          </td>
          <td>
            <p-tag
              [value]="getStatusLabel(transaction.isActive)"
              [severity]="getSeverity(transaction.isActive)">
            </p-tag>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <p-button
                icon="pi pi-pencil"
                (onClick)="editRecurringTransaction(transaction)"
                styleClass="p-button-rounded p-button-text p-button-info"
                pTooltip="Éditer"
                tooltipPosition="top">
              </p-button>
              <p-inputSwitch
                [ngModel]="transaction.isActive"
                [trueValue]="1"
                [falseValue]="0"
                (onChange)="toggleActive(transaction, $event)"
                pTooltip="Activer/Désactiver"
                tooltipPosition="top">
              </p-inputSwitch>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Message si aucune donnée -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center">Aucune transaction récurrente trouvée.</td>
        </tr>
      </ng-template>

    </p-table>
  </p-card>
</div>
