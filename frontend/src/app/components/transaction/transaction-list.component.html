<div class="transaction-list">
  <div class="list-container">
    <!-- En-tête avec titre et bouton -->
    <div class="list-header">
      <div class="header-content">
        <h2 *ngIf="account">{{ account['name'] }}</h2>
        <h2 *ngIf="!account">Toutes les transactions</h2>

        <!-- Affichage des soldes (seulement si compte spécifique) -->
        <div class="balance-display" *ngIf="accountId">
          <div class="balance-item current">
            <div class="balance-label">Solde actuel</div>
            <div class="balance-amount" [class.positive]="currentBalance > 0" [class.negative]="currentBalance < 0">
              {{ currentBalance | currency:'EUR':'symbol':'1.2-2':'fr' }}
            </div>
          </div>
          <div class="balance-separator">
            <i class="pi pi-arrow-right"></i>
          </div>
          <div class="balance-item forecast">
            <div class="balance-label">Solde prévisionnel</div>
            <div class="balance-amount" [class.positive]="forecastedBalance > 0" [class.negative]="forecastedBalance < 0">
              {{ forecastedBalance | currency:'EUR':'symbol':'1.2-2':'fr' }}
            </div>
          </div>
        </div>
      </div>
      <p-button
        label="Nouvelle transaction"
        icon="pi pi-plus"
        (onClick)="createTransaction()"
        styleClass="p-button-success">
      </p-button>
    </div>

    <!-- Bouton pour afficher/masquer les échéances (si compte spécifique) -->
    <div class="recurring-toggle" *ngIf="accountId && recurringTransactions.length > 0">
      <p-button
        [label]="showRecurring ? 'Masquer les échéances' : 'Afficher les échéances (' + recurringTransactions.length + ')'"
        icon="pi pi-calendar"
        (onClick)="toggleRecurring()"
        styleClass="p-button-outlined p-button-secondary">
      </p-button>
    </div>

    <!-- Liste des échéances récurrentes -->
    <div class="recurring-list" *ngIf="showRecurring && sortedRecurringTransactions.length > 0">
      <div class="recurring-items">
        <div *ngFor="let recurring of sortedRecurringTransactions" class="recurring-item" [class.realized]="isRecurringRealized(recurring['id']!)">
          <div class="recurring-info flex items-center">
            <i class="pi pi-calendar mr-2"></i>
            <div class="recurring-details">
              <div class="recurring-description">{{ recurring['label'] }}</div>
              <div class="recurring-schedule">{{ getDayLabel(recurring) }} - {{ recurring['frequency'] === 'monthly' ? 'Mensuel' : 'Hebdomadaire' }}</div>
            </div>
          </div>
          <div class="recurring-amount" [class.positive]="recurring['financialFlowId'] === 1" [class.negative]="recurring['financialFlowId'] === 2">
            {{ (recurring['financialFlowId'] === 2 ? -1 : 1) * (recurring['amount'] || 0) | currency:'EUR':'symbol':'1.2-2':'fr' }}
          </div>
          <div class="recurring-status">
            <i *ngIf="isRecurringRealized(recurring['id']!)" class="pi pi-check-circle realized-icon"></i>
            <i *ngIf="!isRecurringRealized(recurring['id']!)" class="pi pi-clock pending-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Contrôles -->
    <div class="list-controls p-3 surface-card border-round-lg shadow-1">
      <!-- Ligne de filtres -->
      <div class="filters-row flex flex-wrap gap-3">
        <!-- Filtre par date -->
        <p-inputGroup class="flex-1 min-w-[250px]">
          <p-inputGroupAddon><i class="pi pi-calendar"></i></p-inputGroupAddon>
          <p-calendar
            [(ngModel)]="filters.dateRange"
            (onSelect)="applyFilter()"
            (onClearClick)="clearDateFilter()"
            selectionMode="range"
            [readonlyInput]="true"
            placeholder="Filtrer par date"
            dateFormat="dd/mm/yy"
            [showClear]="true"
            styleClass="w-full"
          ></p-calendar>
        </p-inputGroup>

        <!-- Filtre par description -->
        <p-inputGroup class="flex-1 min-w-[250px]">
          <p-inputGroupAddon><i class="pi pi-align-left"></i></p-inputGroupAddon>
          <input
            pInputText
            type="text"
            [(ngModel)]="filters.description"
            (input)="applyFilter()"
            placeholder="Filtrer par description"
            class="w-full"
          />
        </p-inputGroup>

        <!-- Filtre par montant -->
        <p-inputGroup class="flex-1 min-w-[150px]">
          <p-inputGroupAddon><i class="pi pi-dollar"></i></p-inputGroupAddon>
          <input
            pInputText
            type="number"
            min="0"
            step="0.01"
            [(ngModel)]="filters.amount"
            (input)="applyFilter()"
            (keypress)="allowOnlyNumbers($event)"
            placeholder="Filtrer par montant"
            class="w-full"
          />
        </p-inputGroup>
      </div>

      <!-- Ligne des contrôles -->
      <div class="controls-row flex justify-between align-items-center mt-4 flex-wrap gap-3">
        <!-- Groupes par page -->
        <div class="flex align-items-center gap-2">
          <span class="font-medium">Groupes par page :</span>
          <p-dropdown
            [options]="pageSizeOptions"
            [(ngModel)]="pageSize"
            optionLabel="label"
            optionValue="value"
            (onChange)="changePageSize(pageSize)"
            styleClass="w-8rem"
          ></p-dropdown>
        </div>

        <!-- Tri -->
        <div>
          <button
            pButton
            type="button"
            class="p-button-text"
            (click)="sortBy('date')"
            [class.active]="sortColumn === 'date'"
            icon="pi pi-sort-alt"
            label="Trier par date"
          ></button>
        </div>

        <!-- Info résultats -->
        <div class="results-info font-semibold text-color-secondary">
          {{ filteredTransactions.length }} transaction(s)
        </div>
      </div>
    </div>



    <!-- Transactions groupées par date -->
    <div class="grouped-transactions">
      <div *ngFor="let group of paginatedGroupedTransactions" class="date-group">
        <!-- En-tête de date -->
        <div class="date-header">
          <div class="date-label">
            <i class="pi pi-calendar"></i>
            <span class="date-text">{{ group.formattedDate }}</span>
            <span class="transaction-count">({{ group.transactions.length }} transaction{{ group.transactions.length > 1 ? 's' : '' }})</span>
          </div>
          <div class="date-total" [class.positive]="group.total > 0" [class.negative]="group.total < 0">
            {{ group.total | currency:'EUR':'symbol':'1.2-2':'fr' }}
          </div>
        </div>

        <!-- Liste des transactions de cette date -->
        <div class="transactions-list">
          <div *ngFor="let transaction of group.transactions" class="transaction-item">
            <div class="transaction-main">
              <div class="transaction-description">
                <i
                  class="transaction-icon"
                  [ngClass]="{'pi pi-arrow-down text-red-500': (transaction.amountNumber ?? 0) < 0, 'pi pi-arrow-up text-green-500': (transaction.amountNumber ?? 0) > 0}"
                >
                </i>
                <div class="description-content">
                  <div class="description-text">{{ transaction.description }}</div>
                  <div class="subcategory-text">{{ transaction.subCategoryLabel }}</div>
                </div>
              </div>
              <div class="transaction-amount" [class.positive]="(transaction.amountNumber ?? 0) > 0" [class.negative]="(transaction.amountNumber ?? 0) < 0">
                {{ transaction.amountNumber | currency:'EUR':'symbol':'1.2-2':'fr' }}
              </div>
            </div>
            <div class="transaction-actions">
              <p-button
                icon="pi pi-pencil"
                (onClick)="editTransaction(transaction)"
                styleClass="p-button-rounded p-button-text p-button-info"
                pTooltip="Éditer"
                tooltipPosition="top">
              </p-button>
              <p-button
                icon="pi pi-trash"
                (onClick)="deleteTransaction(transaction)"
                styleClass="p-button-rounded p-button-text p-button-danger"
                pTooltip="Supprimer"
                tooltipPosition="top">
              </p-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message si aucune transaction -->
    <div *ngIf="paginatedGroupedTransactions.length === 0" class="no-data">
      <i class="pi pi-info-circle mr-2"></i>
      <span>Aucune transaction trouvée pour les filtres actuels.</span>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="groupedTransactions.length"
        [first]="(currentPage - 1) * pageSize"
        (onPageChange)="onPageChange($event)"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{first} à {last} sur {totalRecords} groupes">
      </p-paginator>
    </div>
  </div>
</div>
