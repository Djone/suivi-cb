<div class="transaction-list">
  <div class="list-container">
    <!-- En-tête avec titre et bouton -->
    <div class="list-header">
      <div class="header-content">
        <h2 *ngIf="account">{{ account['name'] }}</h2>
        <h2 *ngIf="!account">Toutes les transactions</h2>

        <!-- Affichage des soldes (seulement si compte spécifique) -->
        <div class="balance-display" *ngIf="accountId">
          <div class="balance-item current">
            <div class="balance-label">Solde actuel</div>
            <div class="balance-amount" [class.positive]="currentBalance > 0" [class.negative]="currentBalance < 0">
              {{ currentBalance | currency:'EUR':'symbol':'1.2-2':'fr' }}
            </div>
          </div>
          <div class="balance-separator">
            <mat-icon>arrow_forward</mat-icon>
          </div>
          <div class="balance-item forecast">
            <div class="balance-label">Solde prévisionnel</div>
            <div class="balance-amount" [class.positive]="forecastedBalance > 0" [class.negative]="forecastedBalance < 0">
              {{ forecastedBalance | currency:'EUR':'symbol':'1.2-2':'fr' }}
            </div>
          </div>
        </div>
      </div>
      <p-button
        label="Nouvelle transaction"
        icon="pi pi-plus"
        (onClick)="createTransaction()"
        styleClass="p-button-success">
      </p-button>
    </div>

    <!-- Bouton pour afficher/masquer les échéances (si compte spécifique) -->
    <div class="recurring-toggle" *ngIf="accountId && recurringTransactions.length > 0">
      <p-button
        [label]="showRecurring ? 'Masquer les échéances' : 'Afficher les échéances (' + recurringTransactions.length + ')'"
        icon="pi pi-calendar"
        (onClick)="toggleRecurring()"
        styleClass="p-button-outlined p-button-secondary">
      </p-button>
    </div>

    <!-- Liste des échéances récurrentes -->
    <div class="recurring-list" *ngIf="showRecurring && sortedRecurringTransactions.length > 0">
      <div class="recurring-items">
        <div *ngFor="let recurring of sortedRecurringTransactions" class="recurring-item" [class.realized]="isRecurringRealized(recurring['id']!)">
          <div class="recurring-info">
            <mat-icon>{{ recurring['frequency'] === 'monthly' ? 'calendar_month' : 'calendar_today' }}</mat-icon>
            <div class="recurring-details">
              <div class="recurring-description">{{ recurring['label'] }}</div>
              <div class="recurring-schedule">{{ getDayLabel(recurring) }} - {{ recurring['frequency'] === 'monthly' ? 'Mensuel' : 'Hebdomadaire' }}</div>
            </div>
          </div>
          <div class="recurring-amount" [class.positive]="recurring['financialFlowId'] === 1" [class.negative]="recurring['financialFlowId'] === 2">
            {{ (recurring['financialFlowId'] === 2 ? -1 : 1) * (recurring['amount'] || 0) | currency:'EUR':'symbol':'1.2-2':'fr' }}
          </div>
          <div class="recurring-status">
            <mat-icon *ngIf="isRecurringRealized(recurring['id']!)" class="realized-icon">check_circle</mat-icon>
            <mat-icon *ngIf="!isRecurringRealized(recurring['id']!)" class="pending-icon">pending</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Contrôles -->
    <div class="list-controls">
      <div class="filters-row">
        <input type="text" [(ngModel)]="filters.date" (input)="applyFilter()" placeholder="Filtrer par date..." class="filter-input" />
        <input type="text" [(ngModel)]="filters.description" (input)="applyFilter()" placeholder="Filtrer par description..." class="filter-input" />
        <input type="text" [(ngModel)]="filters.amount" (input)="applyFilter()" placeholder="Filtrer par montant..." class="filter-input" />
      </div>
      <div class="controls-row">
        <div class="page-size-selector">
          <label>Groupes par page :</label>
          <select [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
        <div class="sort-controls">
          <button class="sort-btn" (click)="sortBy('date')" [class.active]="sortColumn === 'date'">
            <mat-icon>event</mat-icon>
            Date {{ sortDirection === 'asc' ? '↑' : '↓' }}
          </button>
        </div>
        <div class="results-info">
          {{ filteredTransactions.length }} transaction(s)
        </div>
      </div>
    </div>

    <!-- Transactions groupées par date -->
    <div class="grouped-transactions">
      <div *ngFor="let group of paginatedGroupedTransactions" class="date-group">
        <!-- En-tête de date -->
        <div class="date-header">
          <div class="date-label">
            <mat-icon>event</mat-icon>
            <span class="date-text">{{ group.formattedDate }}</span>
            <span class="transaction-count">({{ group.transactions.length }} transaction{{ group.transactions.length > 1 ? 's' : '' }})</span>
          </div>
          <div class="date-total" [class.positive]="group.total > 0" [class.negative]="group.total < 0">
            {{ group.total | currency:'EUR':'symbol':'1.2-2':'fr' }}
          </div>
        </div>

        <!-- Liste des transactions de cette date -->
        <div class="transactions-list">
          <div *ngFor="let transaction of group.transactions" class="transaction-item">
            <div class="transaction-main">
              <div class="transaction-description">
                <mat-icon class="transaction-icon">{{ transaction.amountNumber && transaction.amountNumber < 0 ? 'arrow_downward' : 'arrow_upward' }}</mat-icon>
                <div class="description-content">
                  <div class="description-text">{{ transaction.description }}</div>
                  <div class="subcategory-text">{{ transaction.subCategoryLabel }}</div>
                </div>
              </div>
              <div class="transaction-amount" [class.positive]="transaction.amountNumber && transaction.amountNumber > 0" [class.negative]="transaction.amountNumber && transaction.amountNumber < 0">
                {{ transaction.amountNumber | currency:'EUR':'symbol':'1.2-2':'fr' }}
              </div>
            </div>
            <div class="transaction-actions">
              <p-button
                icon="pi pi-pencil"
                (onClick)="editTransaction(transaction)"
                styleClass="p-button-rounded p-button-text p-button-info"
                pTooltip="Éditer"
                tooltipPosition="top">
              </p-button>
              <p-button
                icon="pi pi-trash"
                (onClick)="deleteTransaction(transaction)"
                styleClass="p-button-rounded p-button-text p-button-danger"
                pTooltip="Supprimer"
                tooltipPosition="top">
              </p-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message si aucune transaction -->
    <div *ngIf="paginatedGroupedTransactions.length === 0" class="no-data">
      <mat-icon>info</mat-icon>
      <span>Aucune transaction trouvée.</span>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="groupedTransactions.length"
        [first]="(currentPage - 1) * pageSize"
        (onPageChange)="onPageChange($event)"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{first} à {last} sur {totalRecords} groupes">
      </p-paginator>
    </div>
  </div>
</div>
