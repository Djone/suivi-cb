# √âtape 1: Build de l'application Angular en utilisant un "builder"
FROM node:20-alpine AS builder

# D√©finir le r√©pertoire de travail dans le conteneur
WORKDIR /app

# Copier les fichiers de d√©finition du projet (package.json, etc.)
COPY frontend/package*.json ./

# Installer les d√©pendances. 'npm ci' est plus rapide et plus fiable pour les builds.
RUN npm ci

# Copier tout le code source du frontend
COPY frontend/ ./

# Lancer le build de production. La sortie sera dans /app/dist/suivi-cb/browser
RUN npm run build -- --configuration production

# ---

# √âtape 2: Servir l'application avec un serveur Nginx l√©ger
FROM nginx:1.25-alpine

# Supprimer la configuration Nginx par d√©faut
RUN rm /etc/nginx/conf.d/default.conf

# Copier notre configuration Nginx personnalis√©e qui sait g√©rer une SPA
COPY nginx.conf /etc/nginx/nginx.conf

# Copier les fichiers de l'application Angular depuis l'√©tape "builder".
# Le chemin de sortie est /app/dist/frontend/browser car le nom du projet dans package.json est "frontend".
COPY --from=builder /app/dist/frontend/browser /usr/share/nginx/html

# Copier le script d‚Äôattente
COPY frontend/wait-for.sh /wait-for.sh
RUN chmod +x /wait-for.sh

# Exposer le port 80, qui est le port par d√©faut de Nginx
EXPOSE 80

# üïí Attendre le backend avant de d√©marrer Nginx
CMD ["/wait-for.sh", "backend:3001", "--", "nginx", "-g", "daemon off;"]
